#!/bin/sh

# SPDX-License-Identifier: BSD-3-Clause
# Copyright 2025 <Nitrux Latinoamericana S.C. <hello@nxos.org>>

PREREQ=""
prereqs() { echo "$PREREQ"; }

case "${1:-}" in
  prereqs) prereqs; exit 0 ;;
esac

log() { printf '%s\n' "$*" > /dev/console; }

cmdline_has_flag() {
  while read -r a; do
    for p in $a; do
      case "$p" in
        vxm.static_bind=1|vxm.static_bind=yes|vxm.static_bind=true|vxm.static_bind=on) return 0 ;;
      esac
    done
  done < /proc/cmdline
  return 1
}

ensure_mounted() {
  m="$1"
  p="$2"
  if ! mountpoint -q "$p" 2>/dev/null; then
    mount -t "$m" "$m" "$p" 2>/dev/null
  fi
}

ensure_mounted proc /proc
ensure_mounted sysfs /sys

if ! cmdline_has_flag; then
  exit 0
fi

log "[VxM] vxm.static_bind enabled; attempting VFIO capture"

if ! modprobe vfio-pci >/dev/console 2>&1; then
  log "[VxM] modprobe vfio-pci failed"
  exit 1
fi

bind_dev_to_vfio() {
  dev="$1"
  bdf="${dev##*/}"
  dev_dir="/sys/bus/pci/devices/$bdf"
  if [ ! -d "$dev_dir" ]; then
    log "[VxM] $bdf not present under /sys/bus/pci/devices; skipping"
    return 1
  fi

  if [ ! -e "$dev_dir/driver_override" ]; then
    log "[VxM] $bdf has no driver_override; skipping"
    return 1
  fi

  printf '%s' vfio-pci > "$dev_dir/driver_override" 2>/dev/null || {
    log "[VxM] $bdf failed to set driver_override"
    return 1
  }

  if [ -e "$dev_dir/driver/unbind" ]; then
    printf '%s' "$bdf" > "$dev_dir/driver/unbind" 2>/dev/null
  fi

  printf '%s' "$bdf" > /sys/bus/pci/drivers_probe 2>/dev/null

  drv="$(readlink -f "$dev_dir/driver" 2>/dev/null || true)"
  case "$drv" in
    */vfio-pci) log "[VxM] $bdf bound to vfio-pci"; return 0 ;;
    "") log "[VxM] $bdf has no driver after probe"; return 1 ;;
    *) log "[VxM] $bdf bound to ${drv##*/} (expected vfio-pci)"; return 1 ;;
  esac
}

is_vfio_target() {
  dev="$1"
  bdf="${dev##*/}"
  cls="$(cat "/sys/bus/pci/devices/$bdf/class" 2>/dev/null || true)"
  case "$cls" in
    0x03????|0x0403??) return 0 ;;  # VGA (0x03xxxx) and all Audio (0x0403xx)
  esac
  return 1
}

is_vga_or_3d() {
  dev="$1"
  cls="$(cat "$dev/class" 2>/dev/null || true)"
  case "$cls" in
    0x03????) return 0 ;;
  esac
  return 1
}

capture_group_for_gpu() {
  gpu_dev="$1"
  gpu_bdf="${gpu_dev##*/}"
  grp="$(readlink -f "$gpu_dev/iommu_group" 2>/dev/null || true)"
  if [ -z "$grp" ] || [ ! -d "$grp/devices" ]; then
    log "[VxM] $gpu_bdf has no iommu_group; cannot capture"
    return 1
  fi

  log "[VxM] capturing IOMMU group ${grp##*/} for GPU $gpu_bdf"

  ok=0
  fail=0
  skip=0
  target=0

  for d in "$grp"/devices/*; do
    [ -e "$d" ] || continue

    if is_vfio_target "$d"; then
      target=$((target + 1))
      if bind_dev_to_vfio "$d"; then
        ok=$((ok + 1))
      else
        fail=$((fail + 1))
      fi
    else
      skip=$((skip + 1))
      log "[VxM] skipping non-target device ${d##*/}"
    fi
  done

  if [ "$target" -eq 0 ]; then
    log "[VxM] group ${grp##*/} has no VFIO targets; skipping"
    return 1
  fi

  if [ "$fail" -ne 0 ]; then
    log "[VxM] group ${grp##*/} capture incomplete: ok=$ok fail=$fail skip=$skip"
    return 1
  fi

  log "[VxM] group ${grp##*/} capture complete: ok=$ok fail=$fail skip=$skip"
  return 0
}

found=0
captured_groups=""

for bootvga in /sys/bus/pci/devices/*/boot_vga; do
  [ -f "$bootvga" ] || continue
  dev="${bootvga%/boot_vga}"
  is_vga_or_3d "$dev" || continue
  if [ "$(cat "$bootvga" 2>/dev/null)" = "0" ]; then
    found=1
    gpu_bdf="${dev##*/}"

    # Capture the GPU's IOMMU group
    if capture_group_for_gpu "$dev"; then
      grp="$(readlink -f "$dev/iommu_group" 2>/dev/null || true)"
      if [ -n "$grp" ]; then
        captured_groups="$captured_groups ${grp##*/}"
      fi
    fi

    # CRITICAL FIX: Also capture related audio devices (function .1)
    # Modern GPUs often have audio in a SEPARATE IOMMU group
    # Extract bus:device from GPU BDF (e.g., 0000:03:00.0 -> 0000:03:00)
    bus_dev="${gpu_bdf%.*}"
    audio_bdf="${bus_dev}.1"
    audio_dev="/sys/bus/pci/devices/$audio_bdf"

    if [ -d "$audio_dev" ]; then
      log "[VxM] Found related audio device: $audio_bdf"
      audio_grp="$(readlink -f "$audio_dev/iommu_group" 2>/dev/null || true)"

      # Only capture if it's in a different group (avoid double-capture)
      if [ -n "$audio_grp" ]; then
        audio_grp_num="${audio_grp##*/}"
        case " $captured_groups " in
          *" $audio_grp_num "*) log "[VxM] Audio device already captured in group $audio_grp_num" ;;
          *)
            if capture_group_for_gpu "$audio_dev"; then
              captured_groups="$captured_groups $audio_grp_num"
            fi
            ;;
        esac
      fi
    fi
  fi
done

if [ "$found" -eq 0 ]; then
  log "[VxM] no non-boot VGA/3D devices found"
fi

log "[VxM] VFIO capture pass finished"
exit 0
